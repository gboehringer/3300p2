<html>
<head>
<title>INFO 3300 - Data-driven Web Applications</title>
<link href="https://fonts.googleapis.com/css?family=Alegreya|Alegreya+Sans" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Signika" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Lora|Open+Sans" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
</head>
<style>
/*svg { border: solid #ccc 1px; }*/
.main{
    width: 100%;
    text-align: center;
    font-family: 'Open Sans', sans-serif;
  }
.left{
	width: 55%;
	float: left;
	margin-top: 50px;
}
.right{
	width: 45%;
	float: right;
}

#slider{
	width: 70%;
}

</style>
<body>
<div class = "main">
	<div class = "left">
	<svg id = "map" width = "700" height = "500"></svg>
	</div>
	<div class = "right">
	<p id = "educ"></p>
	<button type="button" onclick="plotEduc();">Show All</button>
	<button type="button" onclick="cle();">Clear</button>
	<br><br>
	</div>
	<input id = "slider" type="range" min="2000" max="2014" value="2000" step="1" oninput="showValue(this.value)" />
	<span id="range">2000</span>
	<p id = "tooltip"></p>
</div>




<script>
var height = 550;
var width = 450;
var padding = 10;

//dictionary relating to slider
var yearedu = {};
//data for drugs in a specefic year
var drugyear = [];
//data for drugs in a specific year
var drugs;
//value for current state
var currstate = "Alabama";
//array for sorted drug
var sorteddrug = {};
//array for sorted edu
var sortededu = {};

//For educ chart
var educ_attain = {};
var edu_array, states, xScale, yScale, allPaths, allCircles, paths;
var max_attain = 54.8;
var stateFips = {};

var projection = d3.geoAlbersUsa().scale(75);
var pathGenerator = d3.geoPath().projection(projection);
var rateScale;

var svg = d3.select("#educ").append("svg")
.attr("height", height + 2 * padding)
.attr("width", width + 2 * padding)
.attr("id", "linegraph");

//Build Paths of Education lines in chart
var buildPath = function(d, xScale, yScale){
	var res = "M " + xScale(2000) + ' ' + yScale(d[2000]) + ' L ';
	for (var i = 2001; i < 2015; i++){
		res += " " + xScale(i) + " " + yScale(d[i] + " ");
	}
	return res;	
}

//Show all lines
var plotEduc = function(){
	allPaths = svg.selectAll("path").data(edu_array);
	//console.log(buildPath(educ_attain[0], xScale, yScale));
	allPaths = allPaths.enter().append("path")
	.attr("d", function (d) {return buildPath(d, xScale, yScale);})
	.attr("fill", "none")
	.attr("stroke", "#D3D3D3")
	.attr("stroke-width", 2)
	.attr("opacity", 1)
	.attr("class", "all")
	.attr("id", function(d){return d.state.replace(/ /g,'');})
	.merge(allPaths);

	var points = [];
	for (i in edu_array){
		for (var j = 2000; j < 2015; j++){
				if (edu_array[i][j]){
					points.push({
					"year": j,
					"val": edu_array[i][j],
					"state": edu_array[i].state
					});
				}
				
		}
	}
	d3.selection.prototype.moveToFront = function() {  
      return this.each(function(){
        this.parentNode.appendChild(this);
      });
    };

	allCircles = svg.selectAll("circle").data(points);
	allCircles = allCircles.enter().append("circle")
	.attr("class", "yearPt")
	.attr("cx", function(d){return xScale(d.year);})
	.attr("cy", function(d){if (!d.val) {console.log(d);} return yScale(d.val);})
	.attr("r", 2.4)
	.attr("fill", "#D3D3D3")
	.on("mouseover", function(d){
		svg.select("#temp").text(d.year + " " + d.state + " " + d.val + "%");
		d3.select("#"+d.state.replace(/ /g,'')).attr("stroke-width", 5).attr("stroke", "#FF7F50").moveToFront();
		d3.select(this).attr("r", 6).attr("fill", "#FF7F50").moveToFront();

		var f = stateFips[d.state];
		d3.selectAll("#f" + f.replace(/ /g,'')+".state").attr("opacity", 0.0);
		updatetoolstate(stateFips[d.state]);
	})
	.on("mouseout", function(d){
		d3.select(this).attr("r", 2.4).attr("fill", "#D3D3D3");
		d3.select("#"+d.state.replace(/ /g,'')).attr("stroke-width", 2.9).attr("stroke", "#D3D3D3");

		var f = stateFips[d.state];
		var statesDat = stateAt.get(f);
		d3.select("#f" + f.replace(/ /g,'')+".state").attr("fill", rateScale(statesDat.CrudeRate)).attr("opacity", 1);
	})
	.merge(allCircles);	
};


//Clear all lines
var cle = function(){
	svg.selectAll("path").remove();
	svg.selectAll("circle").remove();
	var xAxis = d3.axisBottom(xScale).tickFormat(d3.format("d"));
	var yAxis = d3.axisLeft(yScale);
	svg.append("g").attr("transform", "translate(0,540)").call(xAxis);
	svg.append("g").attr("transform", "translate(25,0)").call(yAxis);
};

//Show 1 line
var showState = function(st){
	var svg = d3.select("#linegraph");
	svg.append("path")
	.attr("id", educ_attain[st].state.replace(/ /g,''))
	.attr("d", buildPath(educ_attain[st], xScale, yScale))
	.attr("fill", "none")
	.attr("stroke", "#D3D3D3")
	.attr("stroke-width", 2)
	.attr("opacity", 1);
	//.attr("id", educ_attain[st].state);

	var attach= [];
	for (var i = 2000; i < 2015; i++){
		attach.push({
			"state": educ_attain[st].state,
			"year": i,
			"val": educ_attain[st][i]
		});
	}
	d3.selection.prototype.moveToFront = function() {  
      return this.each(function(){
        this.parentNode.appendChild(this);
      });
    };

	var stateCircles = svg.selectAll(".\\"+educ_attain[st].state).data(attach); 
	stateCircles.enter().append("circle")
	.attr("class", function(d){return d["state"];})
	.attr("cx", function(d){return xScale(d["year"])})
	.attr("cy", function(d){return yScale(d["val"])})
	.attr("r", 2.4)
	.attr("fill", "#D3D3D3")
	.on("mouseover", function(d){
		//Hightline Line and Circles
		svg.select("#temp").text(d.year + " " + d.state + " " + d.val + "%");
		d3.select("#"+d.state.replace(/ /g,'')).attr("stroke-width", 5).attr("stroke", "#FF7F50").moveToFront();
		d3.select(this).attr("r", 6).attr("fill", "#FF7F50").moveToFront();
		//Highlight correlating state 
		var f = stateFips[d.state];
		d3.selectAll("#f" + f.replace(/ /g,'')+".state").attr("opacity", 0.0);
		updatetoolstate(stateFips[d.state]);
	})
	.on("mouseout", function(d){
		d3.select(this).attr("r", 2.4).attr("fill", "#D3D3D3");
		d3.select("#"+d.state.replace(/ /g,'')).attr("stroke-width", 2.9).attr("stroke", "#D3D3D3");

		var f = stateFips[d.state];
		var statesDat = stateAt.get(f);
		d3.select("#f" + f.replace(/ /g,'')+".state").attr("fill", rateScale(statesDat.CrudeRate)).attr("opacity", 1);
	})
	.merge(stateCircles);
	
};

//Updates the blue line on chart
var updateeduc = function(year){
    var xScale2 = d3.scaleLinear().domain([2000, 2014]).range([padding*2+5, width-padding]);
    d3.selectAll(".line2")
    .attr("x1", xScale2(year))
    .attr("x2", xScale2(year))
};

var updatetoolstate = function(state){
    currstate = educ_attain[state].state;
    d3.selectAll(".toolstate")
    .text(educ_attain[state].state);

    d3.selectAll(".tooledurank")
    .text(sortededu[currstate] + "");

    d3.selectAll(".tooldrugrank")
    .text(sorteddrug[currstate] + "");

    d3.selectAll(".tooleduperc")
    .text("" + yearedu[educ_attain[state].state]);

    d3.selectAll(".tooldrugperc")
    .text(function(){
        var a;
        drugyear.forEach(function(d){
            if(d.State == educ_attain[state].state){
                a = d.CrudeRate + "";
            }
        })
        return a;
    });

};



var updatetoolyear = function(year){

    d3.selectAll(".toolyear")
    .text(year);

    d3.selectAll(".tooleduperc")
    .text("" + yearedu[currstate]);

    d3.selectAll(".tooldrugperc")
    .text(function(){
        var a;
        drugyear.forEach(function(d){
            if(d.State == currstate){
                a = d.CrudeRate + "";
            }
        })
        return a;
    });

    d3.selectAll(".tooledurank")
    .text(sortededu[currstate] + "");

    d3.selectAll(".tooldrugrank")
    .text(sorteddrug[currstate] + "");


}

//Load all Data
d3.queue()
.defer(d3.json, "us.json")
.defer(d3.csv, "drugs.csv")
.defer(d3.csv, "educattain.csv")
.await(function (error, rawMap, rate, data) {
	if (error) {console.log(error);}
	//Creating Map Scales
	drugs = rate;
	states = topojson.feature(rawMap, rawMap.objects.states);
	stateAt = d3.map(rate, function(d){
		return d.FIPS;
	});
	
	var rate_Arr = [];
	rate.forEach(function(d){
		rate_Arr.push(Number(d.CrudeRate));
		return rate_Arr;
	});
	
	//console.log(rate_Arr);
	var color = ['#e6f2ff','#cce6ff','#99ccff','#66b3ff', '#3399ff', '#0080ff', '#0066cc', '#004080','#00264d', '##000d1a'];
	rateScale = d3.scaleQuantize().domain([0,d3.max(rate_Arr)])
		.range(color);
	//console.log(Math.log(d3.max(rate_Arr)));
	showMap(rateScale, "#map");
	createTool();

	//Parsing + Creating Education Scales
	for (i in data){
		if (data[i].FIPS != "" && data[i].FIPS){
			educ_attain[data[i].FIPS] = {
			"state": data[i].state,
			"2000": data[i]["2000"],
			"2001": data[i]["2001"],
			"2002": data[i]["2002"],
			"2003": data[i]["2003"],
			"2004": data[i]["2004"],
			"2005": data[i]["2005"],
			"2006": data[i]["2006"],
			"2007": data[i]["2007"],
			"2008": data[i]["2008"],
			"2009": data[i]["2009"],
			"2010": data[i]["2010"],
			"2011": data[i]["2011"],
			"2012": data[i]["2012"],
			"2013": data[i]["2013"],
			"2014": data[i]["2014"]
			}; 
			stateFips[data[i].state] = data[i].FIPS;
		}
	}
	edu_array = data;
	xScale = d3.scaleLinear().domain([2000, 2014]).range([padding*2+5, width-padding]);
	yScale = d3.scaleLinear().domain([max_attain, 0]).range([padding, height-padding]);

	var xAxis = d3.axisBottom(xScale).tickFormat(d3.format("d"));
	var yAxis = d3.axisLeft(yScale);
	svg.append("g").attr("transform", "translate(0,540)").call(xAxis);
	svg.append("g").attr("transform", "translate(25,0)").call(yAxis);

	//Horizontal Dotted Lines
	var y = 0;
	while(y <= 55){
		svg.append("line")
		.attr("x1", xScale(2000))
		.attr("y1", yScale(y))
		.attr("x2", xScale(2014))
		.attr("y2", yScale(y))
		.attr("stroke-width", 1)
		.attr("stroke", "black")
		.attr("stroke-dasharray", "5, 10")
		.attr("opacity", "0.2");
		y += 5;
	}

	//Blue slider line
	var line1 = svg.append("line")
    .attr("x1", xScale(2000))
    .attr("y1", padding)
    .attr("x2", xScale(2000))
    .attr("y2", height)
    .attr("stroke-width", 1.5)
    .attr("stroke", "blue")
    .attr("opacity", "0.2")
    .attr("class", "line2");
	//Adding in temporary display
	var svg2 = d3.select("#linegraph");
	svg2.append("text")
	.attr("id", "temp")
	.attr("x", width/2 - 100)
	.attr("y", height-padding*2)
	.style("font-size", "14pt");

	//create initial values for yearedu and drugs
    edu_array.forEach(function(d){
        if(d.state == "United States"){
            ;
        }
        else{
            yearedu[d.state] = d["2000"]; 
        }
    });
    drugs.forEach(function(d) {
	    if(d.Year == "2000"){
	        drugyear.push(d);
	    }
    });
    sortDrug();
    sortEdu();
});

function showMap(scale, placement) {
	var svg = d3.select(placement);
	projection.fitExtent([[0,0], [svg.attr("width"), svg.attr("height")]], states);
	pathGenerator = d3.geoPath().projection(projection);
	
	var paths = svg.selectAll("path.state").data(states.features);
	paths.enter().append("path").attr("class", "state")
	.attr("id", function(state){
		return "f" + state.id;
	})
	.merge(paths)
	.on("mouseover", function(state){
		d3.select(this).attr("opacity", 0.0);
		var st = educ_attain[state.id].state;
		var t = d3.selectAll("#"+st.replace(/ /g,''));
		console.log(t);
		if (t){
			t.attr("stroke-width", 5).attr("stroke", "#FF7F50").moveToFront();
			d3.selectAll("."+st.replace(/ /g,'')).attr("r", 6).attr("fill", "#FF7F50").moveToFront();
		}
		updatetoolstate(state.id);
	})
	.on("mouseout", function(state){
		var statesDat = stateAt.get(state.id);
		d3.select(this).attr("opacity", 1.0).attr("fill", scale(statesDat.CrudeRate));
		var st = educ_attain[state.id].state;
		var t = d3.selectAll("#"+st.replace(/ /g,''));
		if(t){
			t.attr("stroke-width", 2.9).attr("stroke", "#D3D3D3");
			d3.selectAll("."+st.replace(/ /g,'')).attr("r", 2.4).attr("fill", "#D3D3D3");
		}
	})
	.transition().duration(1000)
	.style("stroke", "white")
	.style("fill", function (s) {
		var statesDat = stateAt.get(s.id);
		if(statesDat){
			return(scale(statesDat.CrudeRate));
		}
	})
	.attr("d", function (state) {
		return pathGenerator(state);
	})
	.attr("onclick", function(state){
		return "showState("+state.id+");";
	});
}

 //slider stuff
function showValue(newValue)
{
	drugyear = []
	document.getElementById("range").innerHTML=newValue;

	drugs.forEach(function(d) {
		if(d.Year == newValue){
			drugyear.push(d);
		}
	});

    yearedu = {};
    edu_array.forEach(function(d){
        if(d.state == "United States"){
            ;
        }
        else{
            yearedu[d.state] = d[newValue]; 
        }
    });

    updateeduc(newValue);
    updatetoolyear(newValue);
    sortEdu();
    sortDrug();
}

//Tool Tip
function createTool(){
	height2 = 75;
	width2 = 700;

	var svg2 = d3.select("#tooltip").append("svg")
	.attr("height", height2)
	.attr("width", width2);

	svg2.append("rect")
    .attr("x", 0)
    .attr("y", 0)
    .attr("height", height2/2)
    .attr("width", width2)
    .style("fill", "black")
    .style("fill-opacity", ".3");

    svg2.append("text")
   	.attr("x", width2 / 8)
    .attr("y", height2/3)
    .attr("text-anchor", "middle")
    .attr("font-weight", "bold")
    .attr("font-size", 20)
    .text("State Name");

      svg2.append("text")
   	.attr("x", width2 / 8)
    .attr("y", 5 * height2/ 6)
    .attr("text-anchor", "middle")
    .attr("font-weight", "normal")
    .attr("font-size", 20)
    .text("Alabama")
    .attr("class", "toolstate");

    svg2.append("text")
   	.attr("x", ((0 * width2/ 5))* (3/4) + (1/4 * width2) +  ((width2/ 10) * 3/4))
    .attr("y", height2 /3)
    .attr("text-anchor", "middle")
    .attr("font-weight", "bold")
    .attr("font-size", 20)
    .text("Year");

    svg2.append("text")
   	.attr("x", ((0 * width2/ 5))* (3/4) + (1/4 * width2) +  ((width2/ 10) * 3/4))
    .attr("y", 5 * height2 /6)
    .attr("text-anchor", "middle")
    .attr("font-weight", "normal")
    .attr("font-size", 20)
    .text("2000")
    .attr("class", "toolyear");

     svg2.append("text")
   	.attr("x", ((1 * width2/ 5))* (3/4) + (1/4 * width2) +  ((width2/ 10) * 3/4))
    .attr("y", height2 /3)
    .attr("text-anchor", "middle")
    .attr("font-weight", "bold")
    .attr("font-size", 20)
    .text("Rank");

    svg2.append("text")
   	.attr("x", ((1 * width2/ 5))* (3/4) + (1/4 * width2) +  ((width2/ 10) * 3/4))
    .attr("y",5*  height2 /6)
    .attr("text-anchor", "middle")
    .attr("font-weight", "normal")
    .attr("font-size", 20)
    .text("46")
    .attr("class", "tooledurank");

    svg2.append("text")
   	.attr("x", ((2 * width2/ 5))* (3/4) + (1/4 * width2) +  ((width2/ 10) * 3/4))
    .attr("y", height2 /3)
    .attr("text-anchor", "middle")
    .attr("font-weight", "bold")
    .attr("font-size", 20)
    .text("Rank");

     svg2.append("text")
   	.attr("x", ((2 * width2/ 5))* (3/4) + (1/4 * width2) +  ((width2/ 10) * 3/4))
    .attr("y", 5* height2 /6)
    .attr("text-anchor", "middle")
    .attr("font-weight", "normal")
    .attr("font-size", 20)
    .text("42")
    .attr("class", "tooldrugrank");

    svg2.append("text")
   	.attr("x", ((3 * width2/ 5))* (3/4) + (1/4 * width2) +  ((width2/ 10) * 3/4))
    .attr("y", height2 /3)
    .attr("text-anchor", "middle")
    .attr("font-weight", "bold")
    .attr("font-size", 20)
    .text("Rate");

    svg2.append("text")
   	.attr("x", ((3 * width2/ 5))* (3/4) + (1/4 * width2) +  ((width2/ 10) * 3/4))
    .attr("y", 5* height2 /6)
    .attr("text-anchor", "middle")
    .attr("font-weight", "normal")
    .attr("font-size", 20)
    .attr("fill", "black")
    .text("19")
    .attr("class", "tooleduperc");

    svg2.append("text")
   	.attr("x", ((4 * width2/ 5))* (3/4) + (1/4 * width2) +  ((width2/ 10) * 3/4))
    .attr("y", height2 /3)
    .attr("text-anchor", "middle")
    .attr("font-weight", "bold")
    .attr("font-size", 20)
    .text("Rate");

    svg2.append("text")
   	.attr("x", ((4 * width2/ 5))* (3/4) + (1/4 * width2) +  ((width2/ 10) * 3/4))
    .attr("y", 5* height2 /6)
    .attr("text-anchor", "middle")
    .attr("font-weight", "normal")
    .attr("fill", "black")
    .attr("font-size", 20)
    .text("4.43")
    .attr("class", "tooldrugperc");

    svg2.append("line")
    .attr("x1", width2/ 4)
    .attr("x2", width2/4)
    .attr("y1", 0)
    .attr("y2", height2)
    .style("stroke", "gray")
    .style("stroke-width", "1");

     svg2.append("line")
    .attr("x1", (1 *width2/ 5)*(3/4) +(1/4 * width2) )
    .attr("x2", (1 *width2/ 5)*(3/4) +(1/4 * width2) )
    .attr("y1", 0)
    .attr("y2", height2)
    .style("stroke", "gray")
    .style("stroke-width", "1");

    svg2.append("line")
    .attr("x1", (2 *width2/ 5)*(3/4) +(1/4 * width2) )
    .attr("x2", (2 *width2/ 5)*(3/4) +(1/4 * width2) )
    .attr("y1", 0)
    .attr("y2", height2)
    .style("stroke", "gray")
    .style("stroke-width", "1");

    svg2.append("line")
    .attr("x1", (3 *width2/ 5)*(3/4) +(1/4 * width2) )
    .attr("x2", (3 *width2/ 5)*(3/4) +(1/4 * width2) )
    .attr("y1", 0)
    .attr("y2", height2)
    .style("stroke", "gray")
    .style("stroke-width", "1");

     svg2.append("line")
    .attr("x1", (4 *width2/ 5)*(3/4) +(1/4 * width2) )
    .attr("x2", (4 *width2/ 5)*(3/4) +(1/4 * width2) )
    .attr("y1", 0)
    .attr("y2", height2)
    .style("stroke", "gray")
    .style("stroke-width", "1");
}

var values;
function sortEdu(){
    values = [];
    for( var key in yearedu){
        values.push(yearedu[key]);
    }
    values.sort(function(a,b){
        return a-b;
    });
    var counter = 1;
    for( var i = values.length; i > -1; i--){
        for(var key in yearedu){
            if(values[i] == yearedu[key]){
                sortededu[key] = counter;
            }
        }
        counter++;
    }
}


function sortDrug(){
    temparray = {};
    drugyear.forEach(function(d){
        if(d.State == ""){
            ;
        }
        else{
        	temparray[d.State] = d.CrudeRate;
        }
    });
    values = [];
    for( var key in temparray){
        values.push(temparray[key]);
    }

    values.sort(function(a,b){
        return a-b;
    });
    var counter = 1;
    for( var i = values.length; i > -1; i--){
        drugyear.forEach(function(d){
            if(values[i] == d.CrudeRate){
                sorteddrug[d.State] = counter;
            }
        });
        counter++;
    }
}


</script>




</body>
</html>